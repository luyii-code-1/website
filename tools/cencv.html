<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地震信息</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
        }

        h1 {
            text-align: center;
            color: #333;
        }

        #currentTime {
            text-align: center;
            margin-bottom: 20px;
            color: #777;
        }

        #result {
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #4CAF50;
            color: white;
        }

        .intensity-1 {
            background-color: #e6f7ff;
        }

        .intensity-2 {
            background-color: #ccf2ff;
        }

        .intensity-3 {
            background-color: #b3ecff;
        }

        .intensity-4 {
            background-color: #99e6ff;
        }

        .intensity-5 {
            background-color: #80e0ff;
        }

        .intensity-6 {
            background-color: #66d9ff;
        }

        .intensity-7 {
            background-color: #4dc3ff;
        }

        .intensity-8 {
            background-color: #33adff;
        }

        .intensity-9 {
            background-color: #1a97ff;
        }

        .intensity-10 {
            background-color: #007bff;
            color: white;
        }

        .magnitude-low {
            color: #009688;
        }

        .magnitude-moderate {
            color: #ff9800;
        }

        .magnitude-strong {
            color: #f44336;
        }

        #notificationButton {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 10px;
        }

        #locationForm {
            text-align: center;
            margin-bottom: 20px;
        }

        #locationInput {
            padding: 8px;
        }

        #saveLocationButton {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
        }

        #countdown {
            text-align: center;
            font-size: 20px;
            color: #f44336;
            margin-bottom: 10px;
        }

        #testWarningButton {
            margin-top: 10px;
            padding: 5px 10px;
            font-size: 16px;
            cursor: pointer;
        }

        #alertInfo {
            margin-top: 20px;
            padding: 10px;
            background-color: #FFD700;
            display: none;
        }
    </style>
</head>
<body>
    <h1>地震信息</h1>
    <div id="locationForm">
        <label for="locationInput">请输入经纬度（格式：纬度,经度）：</label>
        <input type="text" id="locationInput" placeholder="自动获取" />
        <button id="saveLocationButton" onclick="saveLocation()">保存位置</button>
    </div>

    <div id="alertInfo">
        <h3>预警信息</h3>
        <p id="alertDetails"></p>
    </div>

    <button id="notificationButton" onclick="testNotification()">测试通知</button>
    <button id="testWarningButton" onclick="testWarning()">测试预警</button>

    <div id="currentTime"></div>
    <div id="countdown"></div>
    <div id="result"></div>

    <script>
        var lastNotificationTime = 0;
        var locationInput = document.getElementById('locationInput');
        var countdownElement = document.getElementById('countdown');

        function testWarning() {
            var testEarthquake = {
                "type": "test",
                "time": new Date().toLocaleString(),
                "location": "测试地点",
                "magnitude": (Math.random() * 2 + 3).toFixed(1),
                "depth": Math.floor(Math.random() * 20 + 1),
                "latitude": (Math.random() * 180 - 90).toFixed(2),
                "longitude": (Math.random() * 360 - 180).toFixed(2)
            };

            sendNotification(testEarthquake);
            startCountdown();
            showAlertInfo(testEarthquake);
        }

        function fetchData() {
    fetch('https://api.wolfx.jp/cenc_eqlist.json')
        .then(response => response.json())
        .then(data => {
            parseJSON(data);
            testWarning();  // 移动到数据解析后
            setTimeout(fetchData, 2000);
        })
        .catch(error => console.error('API请求失败', error));
}


        function parseJSON(jsonData) {
            var currentTime = new Date();
            document.getElementById('currentTime').innerText = '当前时间：' + currentTime.toLocaleTimeString();

            var resultHTML = "<table>";
            resultHTML += "<tr><th>编号</th><th>类型</th><th>时间</th><th>地点</th><th>震级</th><th>深度</th><th>纬度</th><th>经度</th></tr>";

            var latestEarthquake = null;
            var latestTime = 0;

            for (var key in jsonData) {
                if (jsonData.hasOwnProperty(key) && key !== "md5") {
                    var earthquake = jsonData[key];
                    var earthquakeTime = new Date(earthquake.time).getTime();

                    if (earthquakeTime > latestTime) {
                        latestTime = earthquakeTime;
                        latestEarthquake = earthquake;
                    }

                    var intensityClass = "intensity-" + earthquake.magnitude.replace(".", "");
                    var magnitudeClass = getMagnitudeClass(earthquake.magnitude);

                    resultHTML += "<tr class='" + intensityClass + " " + magnitudeClass + "'>";
                    resultHTML += "<td>" + key + "</td>";
                    resultHTML += "<td>" + getTypeText(earthquake.type) + "</td>";
                    resultHTML += "<td>" + earthquake.time + "</td>";
                    resultHTML += "<td>" + earthquake.location + "</td>";
                    resultHTML += "<td>" + earthquake.magnitude + "</td>";
                    resultHTML += "<td>" + earthquake.depth + "</td>";
                    resultHTML += "<td>" + earthquake.latitude + "</td>";
                    resultHTML += "<td>" + earthquake.longitude + "</td>";
                    resultHTML += "</tr>";
                }
            }

            resultHTML += "</table>";
            document.getElementById('result').innerHTML = resultHTML;

            if (latestTime > lastNotificationTime) {
                sendNotification(latestEarthquake);
                startCountdown();
                showAlertInfo(latestEarthquake);
            }
        }

        function sendNotification(earthquake) {
            lastNotificationTime = new Date(earthquake.time).getTime();

            var notificationOptions = {
                body: '发生地震！震级：' + earthquake.magnitude + '，地点：' + earthquake.location,
                icon: 'eewo.png'
            };

            if ('Notification' in window) {
                Notification.requestPermission().then(function (permission) {
                    if (permission === 'granted') {
                        var notification = new Notification('地震通知', notificationOptions);
                        playNotificationSound();
                    }
                });
            }
        }

        function playNotificationSound() {
            var audio = new Audio('update.mp3');
            audio.play();
        }

        function testWarning() {
    var testEarthquake = {
        "type": "test",
        "time": new Date().toLocaleString(),
        "location": "测试地点",
        "magnitude": (Math.random() * 2 + 3).toFixed(1),
        "depth": Math.floor(Math.random() * 20 + 1),
        "latitude": (Math.random() * 180 - 90).toFixed(2),
        "longitude": (Math.random() * 360 - 180).toFixed(2)
    };

    sendNotification(testEarthquake);
    startCountdown();
    showAlertInfo(testEarthquake);  // 添加这一行
}

            sendNotification(testEarthquake);
        }

        function getMagnitudeClass(magnitude) {
            if (magnitude < 4) {
                return "magnitude-low";
            } else if (magnitude < 7) {
                return "magnitude-moderate";
            } else {
                return "magnitude-strong";
            }
        }

        function getTypeText(type) {
            return type === "automatic" ? "自动测定" : "正式测定";
        }

        function saveLocation() {
            var locationValue = locationInput.value;
            if (locationValue) {
                document.cookie = 'customLocation=' + locationValue;
            }
             fetchData();
        }

        function getLocationFromCookie() {
            var name = 'customLocation=';
            var decodedCookie = decodeURIComponent(document.cookie);
            var cookieArray = decodedCookie.split(';');
            for (var i = 0; i < cookieArray.length; i++) {
                var cookie = cookieArray[i];
                while (cookie.charAt(0) === ' ') {
                    cookie = cookie.substring(1);
                }
                if (cookie.indexOf(name) === 0) {
                    return cookie.substring(name.length, cookie.length);
                }
            }
            return null;
        }

        function startCountdown() {
            var countdown = 5;
            countdownElement.innerText = '距离横波到达还有 ' + countdown + ' 秒';

            var countdownInterval = setInterval(function () {
                countdown--;
                countdownElement.innerText = '距离横波到达还有 ' + countdown + ' 秒';

                if (countdown === 0) {
                    clearInterval(countdownInterval);
                    sendHorizontalWaveNotification();
                }
            }, 1000);
        }

        function sendHorizontalWaveNotification() {
            var horizontalWaveNotificationOptions = {
                body: '横波已到达！请注意保护自己。',
                icon: 'eewo.png'
            };

            if ('Notification' in window) {
                Notification.requestPermission().then(function (permission) {
                    if (permission === 'granted') {
                        var horizontalWaveNotification = new Notification('地震横波通知', horizontalWaveNotificationOptions);
                        playNotificationSound();
                    }
                });
            }
        }

        function showAlertInfo(alert) {
    var alertDetails = document.getElementById("alertDetails");
    alertDetails.innerHTML = `地震位置：${alert.location}<br>我的位置：${getLocationFromCookie()}<br>距离：${calculateDistance(alert)} km<br>震深：${alert.depth} km<br>震级：${alert.magnitude}<br>类型：${alert.type}`;

    // 修改的地方：显示预警信息区域
    var alertInfo = document.getElementById("alertInfo");
    alertInfo.style.display = "block";
    
    // 在页面上方更新当前最新的地震信息
    var resultHTML = "<table>";
    resultHTML += "<tr><th>编号</th><th>类型</th><th>时间</th><th>地点</th><th>震级</th><th>深度</th><th>纬度</th><th>经度</th></tr>";

    var intensityClass = "intensity-" + alert.magnitude.replace(".", "");
    var magnitudeClass = getMagnitudeClass(alert.magnitude);

    resultHTML += "<tr class='" + intensityClass + " " + magnitudeClass + "'>";
    resultHTML += "<td>1</td>";
    resultHTML += "<td>" + getTypeText(alert.type) + "</td>";
    resultHTML += "<td>" + alert.time + "</td>";
    resultHTML += "<td>" + alert.location + "</td>";
    resultHTML += "<td>" + alert.magnitude + "</td>";
    resultHTML += "<td>" + alert.depth + "</td>";
    resultHTML += "<td>" + alert.latitude + "</td>";
    resultHTML += "<td>" + alert.longitude + "</td>";
    resultHTML += "</tr>";

    resultHTML += "</table>";
    document.getElementById('result').innerHTML = resultHTML;
}

    </script>
</body>
</html>
